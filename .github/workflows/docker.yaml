name: Sync Docker Images to Aliyun ACR

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:
  sync:
    name: Pull and Push Images to Aliyun ACR
    runs-on: ubuntu-22.04  # æ˜ç¡®æŒ‡å®šè¾ƒæ–°ç³»ç»Ÿï¼Œç£ç›˜ç•¥ä¼˜

    steps:
      - name: Show initial disk usage
        run: |
          echo "=== Initial Disk Usage ==="
          df -hT
          echo "==========================="

      # ğŸ”¥ å…³é”®ï¼šæœ€å¤§åŒ–å¯ç”¨ç©ºé—´ + å½»åº•æ¸…ç† Docker
      - name: Maximize build space
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: true
          remove-haskell: true
          remove-android: true
          remove-codeql: true
          build-mount-path: '/var/lib/docker/'

      - name: Wipe Docker storage completely
        run: |
          echo "Stopping Docker..."
          sudo systemctl stop docker
          echo "Removing /var/lib/docker/* ..."
          sudo rm -rf /var/lib/docker/*
          echo "Starting Docker..."
          sudo systemctl start docker
          sleep 5

      - name: Verify clean state
        run: |
          echo "=== After cleanup ==="
          df -hT
          docker system df || echo "Docker not ready yet"

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Aliyun ACR
        run: |
          echo "$ALIYUN_REGISTRY_PASSWORD" | docker login --username "$ALIYUN_REGISTRY_USER" --password-stdin "$ALIYUN_REGISTRY"

      - name: Process and push images from images.txt
        run: |
          # æ£€æŸ¥ images.txt æ˜¯å¦å­˜åœ¨
          if [ ! -f images.txt ]; then
            echo "âŒ Error: images.txt not found!"
            exit 1
          fi

          # Step 1: Detect duplicate image names across namespaces
          declare -A duplicate_images
          declare -A temp_map

          while IFS= read -r line || [ -n "$line" ]; do
            [[ -z "$line" ]] && continue
            [[ "$line" =~ ^[[:space:]]*# ]] && continue

            image=$(echo "$line" | awk '{print $NF}' | sed 's/@.*$//')
            image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
            image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')

            # Extract namespace (handle docker.io/nginx case)
            parts=(${image//\// })
            if [ ${#parts[@]} -eq 3 ]; then
              ns="${parts[1]}"
            elif [ ${#parts[@]} -eq 2 ]; then
              ns="${parts[0]}"
            else
              ns=""
            fi
            ns_safe="${ns:-_}"

            if [[ -n "${temp_map[$image_name]}" ]] && [[ "${temp_map[$image_name]}" != "$ns_safe" ]]; then
              duplicate_images[$image_name]="true"
            else
              temp_map[$image_name]="$ns_safe"
            fi
          done < images.txt

          # Step 2: Process each image
          while IFS= read -r line || [ -n "$line" ]; do
            [[ -z "$line" ]] && continue
            [[ "$line" =~ ^[[:space:]]*# ]] && continue

            echo "--------------------------------------------------"
            echo "Processing line: $line"

            # Extract platform if present
            if [[ "$line" == *"--platform"* ]]; then
              platform=$(echo "$line" | grep -oP '--platform\s*=?\s*\K\S+')
              pull_cmd="docker pull --platform $platform"
              platform_prefix="${platform//\//_}_"
            else
              pull_cmd="docker pull"
              platform_prefix=""
            fi

            image=$(echo "$line" | awk '{print $NF}' | sed 's/@.*$//')
            echo "Pulling: $image"
            $pull_cmd "$image"

            # Parse image components
            image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
            image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')

            parts=(${image//\// })
            if [ ${#parts[@]} -eq 3 ]; then
              ns="${parts[1]}"
            elif [ ${#parts[@]} -eq 2 ]; then
              ns="${parts[0]}"
            else
              ns=""
            fi

            # Build new tag
            ns_prefix=""
            if [[ -n "${duplicate_images[$image_name]}" ]] && [[ -n "$ns" ]]; then
              ns_prefix="${ns}_"
            fi

            new_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/${platform_prefix}${ns_prefix}${image_name_tag}"
            echo "Tagging as: $new_image"
            docker tag "$image" "$new_image"

            echo "Pushing to Aliyun ACR..."
            docker push "$new_image"

            # ğŸ”¥ å…³é”®ï¼šç«‹å³æ¸…ç†æœ¬åœ°é•œåƒ + ç³»ç»Ÿç¼“å­˜
            echo "Cleaning up local images..."
            docker rmi "$image" "$new_image" 2>/dev/null || true
            docker system prune -f --volumes 2>/dev/null || true

            echo "Disk usage after cleanup:"
            df -h /var/lib/docker || df -h
            echo "--------------------------------------------------"
          done < images.txt

          echo "âœ… All images processed successfully."

      - name: Final disk report
        if: always()
        run: |
          echo "=== Final Disk Usage ==="
          df -hT
          docker system df 2>/dev/null || echo "Docker info unavailable"
